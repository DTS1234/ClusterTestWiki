<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Implementation - Cluster Test Wiki</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Implementation";
        var mkdocs_page_input_path = "probe-builder/implementation.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="../../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> Cluster Test Wiki
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">Overview</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../overview/introduction/">Introduction</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Cluster Probe</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../cluster-probe/requirements/">Requirements</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../cluster-probe/design/">Design</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../cluster-probe/implementation/">Implementation</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../cluster-probe/user-guide/">User guide</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Probe Builder</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../requirements/">Requirements</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../design/">Design</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">Implementation</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#introduction">Introduction</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#jmeterservice">JmeterService</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#report-creator">Report Creator</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#controller">Controller</a>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../user-guide/">User guide</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Testing reCluster</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../../setup.md">testing reCluster</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">Cluster Test Wiki</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a> &raquo;</li>
          <li>Probe Builder &raquo;</li>
      <li>Implementation</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h2 id="implementation">Implementation</h2>
<h3 id="introduction">Introduction</h3>
<p>ProbeBuilder simillary as ClusterProbe is written in <a href="https://www.oracle.com/java/technologies/javase/jdk17-archive-downloads.html">Java 17</a>, and it also uses
the <a href="https://spring.io/projects/spring-boot">Spring Boot Framework</a>.</p>
<p>More than that however there are few dependencies that are worth mentioning regarding the implementation part of the probe builder:</p>
<ul>
<li>JMeter Java API: Used for creating and executing load tests within the application.</li>
<li>Tablesaw: Employed for data manipulation and analysis in a tabular format.</li>
<li>Maven: The build tool utilized for managing dependencies and project build processes.</li>
<li>Vanilla JavaScript and HTML: Used to build a simple yet effective frontend for the application.</li>
</ul>
<p><img alt="img.png" src="../../img/cluster-probe-packages.png" /></p>
<p>The main server side code is implemented in the jmeter package that stores all the important classes connected with the jmeter integration as well as reporting
and test results data management.</p>
<h3 id="jmeterservice">JmeterService</h3>
<p>Most of the methods in this class are focused around the Jmeter test preparation and execution, there are several methods that use directly
the <a href="https://jmeter.apache.org/api/index.html">Jmeter Java API</a> like:</p>
<pre><code>@NotNull
private static TestPlan buildTestPlan() {
    TestPlan testPlan = new TestPlan(&quot;Create JMeter Script From Java Code&quot;);
    testPlan.setProperty(TestElement.TEST_CLASS, TestPlan.class.getName());
    testPlan.setProperty(TestElement.GUI_CLASS, TestPlanGui.class.getName());
    testPlan.setUserDefinedVariables((Arguments) new ArgumentsPanel().createTestElement());
    return testPlan;
}
</code></pre>
<p>or</p>
<pre><code>@NotNull
private static ThreadGroup buildThreadGroup(JmeterSpecification spec, LoopController loopController) {
    ThreadGroup threadGroup = new ThreadGroup();
    threadGroup.setName(&quot;Thread Group&quot;);
    threadGroup.setNumThreads(spec.getNumberOfThreads());
    threadGroup.setRampUp(spec.getRampUpPeriod());
    threadGroup.setSamplerController(loopController);
    threadGroup.setProperty(TestElement.TEST_CLASS, ThreadGroup.class.getName());
    threadGroup.setProperty(TestElement.GUI_CLASS, ThreadGroupGui.class.getName());
    return threadGroup;
}
</code></pre>
<p>where you can see that <code>JmeterSpecification</code> parameters are passed to some fields of the <code>threadGroup</code> configuration.</p>
<p>All the jmeter builder methods are used in the main public <code>jmeterStart</code> method.</p>
<pre><code>// First HTTP Sampler
HTTPSamplerProxy sampler = buildSampler(spec);

// Loop Controller
LoopController loopController = buildLoopController();

// Thread Group
ThreadGroup threadGroup = buildThreadGroup(spec, loopController);

// Test Plan
TestPlan testPlan = buildTestPlan();
</code></pre>
<p>after all the tests elements are set up, there is a thread prepared and executed with the testPlan constructed:</p>
<pre><code>Thread thread = new Thread(() -&gt; {

        String date = LocalDateTime.now().format(DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd HH:mm:ss&quot;));
        repo.save(new JmeterResultData(date, fileName + &quot;.jtl&quot;, fileName + &quot;.jmx&quot;,
            String.valueOf(spec.getNumberOfThreads()),
            String.valueOf(spec.getRampUpPeriod()),
            spec.getPath(),
            false
        ));

        jmeter.run();

        ReportCreator.create(fileName+&quot;.csv&quot;);

        repo.save(new JmeterResultData(date, fileName + &quot;.csv&quot;, fileName + &quot;.jmx&quot;,
            String.valueOf(spec.getNumberOfThreads()),
            String.valueOf(spec.getRampUpPeriod()),
            spec.getPath(),
            true
        ));
    });

</code></pre>
<p><code>JmeterResultData</code> for a test is saved just before the test invocation as well as just after it. There is also a report created with a
static <code>ReportCreator.create()</code> method call.</p>
<h3 id="report-creator">Report Creator</h3>
<p><code>ReportCreator</code> class takes advantage of the tablesaw library for plotting. The main method for this class is a <code>create</code> method.
This method is a static utility method that takes a file path as input and generates a report based on the data present in the file.</p>
<p>The method reads data from a CSV file specified by the file parameter and loads it into a Tablesaw Table object. Later on latency and success categories are
calculated.</p>
<p>Then the method creates plots:</p>
<ul>
<li>"Errors and Success" plot: A horizontal bar plot showing the count of successful and failed operations.</li>
<li>"Latency over time" plot: A time series plot showing how the latency (response time) changes over time (represented by the "count" column).</li>
</ul>
<p>At the end the method generates an HTML report file containing the two plots using the ReportData class. The report file is named based on the input CSV file
but with a ".html" extension.</p>
<pre><code>public static ReportData create(String file) {

        try {
            Table table = Table.read().file(new File(file));
            table.addColumns(DoubleColumn.create(&quot;count&quot;, IntStream.range(1, table.rowCount() + 1).toArray()));

            DoubleColumn latencySeconds = table.intColumn(&quot;Latency&quot;).divide(1000).setName(&quot;Latency seconds&quot;);
            table.addColumns(latencySeconds);

            CategoricalColumn&lt;?&gt; success = table.categoricalColumn(&quot;success&quot;);
            Table successCategory = success.countByCategory();

            Figure errrorsAndSuccessPlot = HorizontalBarPlot.create(&quot;Errors and success&quot;, successCategory, &quot;Category&quot;, &quot;Count&quot;);
            Figure latencyOverTime = TimeSeriesPlot.create(&quot;Latency over time&quot;, table, &quot;count&quot;, &quot;Latency seconds&quot;);

            return new ReportData(
                createHTMLFile(&quot;report&quot; + file.replaceAll(&quot;.csv&quot;, &quot;.html&quot;), Arrays.asList(latencyOverTime, errrorsAndSuccessPlot)),
                String.valueOf(getErrorCount(successCategory)),
                getLatencyMean(table)
            );

        } catch (IOException e) {
            throw new IllegalStateException(&quot;Failed to create a report for &quot; + file);
        }

    }
</code></pre>
<h3 id="controller">Controller</h3>
<p>Similar as for to the cluster-probe, probe-builder exposes its Rest API with a Spring Boot RestController class.</p>
<p>There are two main methods for this <code>Controller</code>:</p>
<ul>
<li><code>jmeterRun</code> - This method is the handler for the "/run" POST endpoint. It takes a JmeterSpecification object as input, which is deserialized from the request
  body using @RequestBody. If the spec is not provided (null), it creates a default JmeterSpecification object and starts the JMeter test with the default
  values. Otherwise, it starts the JMeter test with the specified JmeterSpecification.</li>
<li><code>results</code> - This method is the handler for the "/results" GET endpoint. It returns a Map of JmeterResultData, which contains the results of JMeter tests performed by the
  jmeterService.</li>
</ul>
<pre><code>@RestController
@RequiredArgsConstructor
public class Controller {

    private final JmeterService jmeterService;

    @PostMapping(&quot;/run&quot;)
    @CrossOrigin
    public void jmeterRun(@RequestBody JmeterSpecification spec) throws IOException {
        if (spec == null) {
            jmeterService.jmeterStart(new JmeterSpecification(100, 20, &quot;localhost&quot;, 8080, &quot;/api/load&quot;, &quot;POST&quot;, &quot;{\&quot;key1\&quot;:\&quot;value1\&quot;}&quot;));
        } else {
            jmeterService.jmeterStart(spec);
        }
    }

    @GetMapping(&quot;/results&quot;)
    @CrossOrigin
    public Map&lt;String, JmeterResultData&gt; results() {
        return jmeterService.getAllResults();
    }
}
</code></pre>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../design/" class="btn btn-neutral float-left" title="Design"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../user-guide/" class="btn btn-neutral float-right" title="User guide">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../design/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../user-guide/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme_extra.js" defer></script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
